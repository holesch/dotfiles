# === Prezto ===
if [[ -s "${ZDOTDIR:-$HOME}/.zprezto/init.zsh" ]]; then
  source "${ZDOTDIR:-$HOME}/.zprezto/init.zsh"
fi

# === Color scheme ===
export BASE16_SCHEME="google-light"
if [[ -s "$HOME/dotfiles/base16-$BASE16_SCHEME.sh" && -z "$VIM_TERMINAL" ]]; then
    source "$HOME/dotfiles/base16-$BASE16_SCHEME.sh"
fi

# === Key remaps ===
if [[ `uname` == "Linux" && -n "$DISPLAY" ]] && type setxkbmap > /dev/null; then
    # remap capslock to CTRL
    setxkbmap -layout us -option ctrl:nocaps
elif [[ `uname` == "Darwin" ]] && type hidutil > /dev/null; then
    # remap section to backtick
    hidutil property --set '{"UserKeyMapping":[{"HIDKeyboardModifierMappingSrc":0x700000064,"HIDKeyboardModifierMappingDst":0x700000035}]}' > /dev/null
fi

# === Terminal ===
stty -ixon # disable flow control (CTRL-S, CTRL-Q)
stty dsusp undef 2>/dev/null # disable delayed suspend (CTRL-Y)

# === Environment ===
export KEYTIMEOUT=1
export BB_NUMBER_THREADS="8"
export PARALLEL_MAKE="-j8"
export MAKEFLAGS="-j8"
export GPG_TTY="$(tty)"
export DOCKER_CONFIG="$HOME"/.config/docker
export CARGO_HOME="$HOME"/.local/share/cargo
export RUSTUP_HOME="$HOME"/.local/share/rustup

# === Alias ===
alias sshi='ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR'
alias scpi='scp -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR'
alias n='e ~/work/notes/scratchpad.txt'
alias qr='qrencode --margin 2 --type UTF8'
alias gdb='gdb -q'
alias tshark='tshark --color'
unalias man
man() {
    local cols=$(tput cols)
    MANWIDTH=$((cols > 120 ? 120 : cols)) command man "$@"
}
gpg-agent-setup() {
    gpg-connect-agent updatestartuptty "scd serialno" "learn --sendinfo" /bye \
        | awk '/^S KEYPAIRINFO/{system("gpg-connect-agent \"delete_key --force --stub-only " $3 "\" >/dev/null")}'
}
cpr() {
    time rsync --archive -hh --partial --info=stats1,progress2 --modify-window=1 "$@"
}

# === zsh key bindings ===
bindkey '^_' undo

# === zsh options ===
HISTSIZE=10000000 # The maximum number of events to save in the internal history.
SAVEHIST=10000000 # The maximum number of events to save in the history file.

# === tmux autostart ===
if [[ -z "$TMUX" && -z "$EMACS" && -z "$VIM" && \
    -z "$INSIDE_EMACS" && -z "$VSCODE_PID" && -z "$SSH_TTY" ]]
then
    tmux start-server
    tmux_session='zshrc'

    if ! tmux has-session -t "$tmux_session" 2> /dev/null; then
        tmux \
            new-session -d -s "$tmux_session" \; \
            set-option -t "$tmux_session" destroy-unattached off &> /dev/null
        # Restore saved session
        $HOME/dotfiles/tmux/plugins/resurrect/scripts/restore.sh 2> /dev/null
        # Attach to the new session
        exec tmux attach-session -d -t "$tmux_session"
    elif [[ -z `tmux list-clients -t $tmux_session` ]]; then
        # Attach to the existing session
        exec tmux attach-session -d -t "$tmux_session"
    fi
fi

# === Local config ===
if [[ -s "$HOME/.zshrc_local" ]]; then
    source "$HOME/.zshrc_local"
fi

source $HOME/dotfiles/zsh/functions/_tmux_pane_words.zsh
